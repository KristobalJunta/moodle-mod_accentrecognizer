define(["jquery","core/notification","core/templates","core/str"],function(a,b,c,d){function e(b){var c=a('[data-action="record"]');"default"===b?d.get_string("accentrecognizer_record","mod_accentrecognizer").done(function(a){var b=document.createElement("i");b.className="fa fa-microphone fa-2x",b.style.verticalAlign="middle";var d=b.outerHTML+" "+a;c.removeClass("btn-danger btn-warning").addClass("btn-primary"),c.html(d),c.prop("disabled",!1)}):"recording"===b?d.get_string("accentrecognizer_stop","mod_accentrecognizer").done(function(a){var b=document.createElement("i");b.className="fa fa-stop fa-2x",b.style.verticalAlign="middle";var d=b.outerHTML+" "+a;c.removeClass("btn-primary btn-warning").addClass("btn-danger"),c.html(d),c.prop("disabled",!1)}):"sending"===b&&d.get_string("accentrecognizer_sending","mod_accentrecognizer").done(function(a){var b=document.createElement("i");b.className="fa fa-spinner fa-2x fa-spin",b.style.verticalAlign="middle";var d=b.outerHTML+" "+a;c.removeClass("btn-danger btn-primary").addClass("btn-warning"),c.html(d),c.prop("disabled",!0)}),c.data("state",b)}function f(a){var b=["None",-100];for(var c in a)a[c]>b[1]&&(b=[c,a[c]]);return b[0]}function g(a){a&&(l=a),navigator.mediaDevices.getUserMedia({audio:!0}).then(function(a){k=new MediaRecorder(a)})["catch"](b.exception)}function h(){if(!k)return b.exception("Error using recorder!"),!1;var d=[];k.ondataavailable=function(g){if(d.push(g.data),"inactive"==k.state){var h=new Blob(d,{type:"audio/webm"}),i=new FormData,j=URL.createObjectURL(h).split("/"),m=j[j.length-1];i.append("file",h,m),a.post({url:"http://localhost:5000/classify",data:i,processData:!1,contentType:!1}).done(function(a){var d=f(a),g={closestAccent:d,engSimilarity:parseInt(100*a.EN)};e("default"),c.render("mod_accentrecognizer/recognition_results",g).then(function(a){l.innerHTML=a}).fail(b.exception)})}},k.start(1e3)}function i(){return k?void k.stop():(b.exception("Error using recorder!"),!1)}function j(){a("body").on("click",'[data-action="record"]',function(){var b=a(this);"default"===b.data("state")?(e("recording"),h()):"recording"===b.data("state")&&(e("sending"),i())})}var k=!1,l=document.body,m={init:function(){g(document.querySelector('[data-role="record-output"]')),j()}};return m});